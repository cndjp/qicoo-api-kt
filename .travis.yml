language: java
jdk:
  - openjdk11

sudo: required

services:
  - docker
  - mysql
  - redis-server

env:
  global:
    - MYSQL_USER="root"
    - MYSQL_HOST="127.0.0.1"
    - MYSQL_DB="qicoo2db"
    - MYSQL_PORT="3306"
    - REDIS_HOST="localhost"
    - REDIS_PORT="6379"
    - DOCKER_REPO='cndjp/qicoo-api-kt'
    - secure: 'K9PIzQ1jB2iKuU+NZHLvIcpW+TDQE8BhI+3tKpBy+SFBtoCFoIITFj25SE1zqErKsuek0qk/7Ci0IojdGRrJjKjnUXlfofkXPNAEVs1ONafSrzc1ar5Iu9F0/6D15NGg45WZcWlSI8zMiuk7DP/PC1UImImXjsiLzDx7R5TgFk9QucRQbDLgKj6V2MRkqDTc8av2sPedNOJQSEckfq8sF3znUQCMo8WOj2DckDAmfrVK4Y5cgCYKbF9TwvXP82q+3Ror9LB7luI7RIr3NfXydN8Gsb0bNQ0qWuH73zblHEwFPVzMK+Sqj4c8SFZq3dNnNRR4lwB64qGEnGnVwNRePy2/1LWdfMY5o0NzXJOOPRCknD++6qgXziiIWrqHuYQnmtB2MUe1l2YTn5gRb01LdBVtGy2xWig5ecXF20DSM/MBW8GRaYi71I9R7G8zbiHRdJ8wz3mwoMc2CKe2T6Vpgy20ldR4gZzFv5DswkjdzpIkjSlSI22r7Gmo9rKXOy03zZP0pruM4sgxaMJED3F7pYPeGMM4pEDjn4Bqe6aP9+fuahp5ARF0DvWI1mCEpMNo51kzZgmBdEPcE8N0lTXVRx17gHt4GPlIMb4XJWyhNU2yWGHux+9kHW8elw7QUThP/OTHEeoTwMVk5ONPn64z2g9C3CFEyYzob2N4RzTwb+Q='

before_install:
  - export TZ=Asia/Tokyo
  - curl -s api.sdkman.io | bash
  - source /home/travis/.sdkman/bin/sdkman-init.sh # ターミナル上での表示結果
  - sdk list gradle
  - sdk install gradle 5.6.2
  - sdk default gradle 5.6.2

before_script:
  - echo 'Asia/Tokyo' | sudo tee /etc/timezone
  - sudo dpkg-reconfigure --frontend noninteractive tzdata
  - date
  - mkdir /opt/bin
  - curl -LSfs https://japaric.github.io/trust/install.sh | sh -s -- --git casey/just --target x86_64-unknown-linux-musl --to /opt/bin/
  - export PATH=/opt/bin:$PATH
  - just version
  - mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root mysql
  - echo "CREATE DATABASE IF NOT EXISTS ${MYSQL_DB}" | mysql -h${MYSQL_HOST} -uroot
  - echo 'set global time_zone = "Asia/Tokyo"' | mysql -h${MYSQL_HOST} -uroot

script:
  - just test
  - just build
  - just docker-release

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  bundler: true
  directories:
    - ${HOME}/.gradle/caches/
    - ${HOME}/.gradle/wrapper/
    - ${HOME}/.android/build-cache
